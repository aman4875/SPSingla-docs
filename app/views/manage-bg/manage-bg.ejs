<!DOCTYPE html>
<html lang="zxx" class="js">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" />
    <!-- Fav Icon  -->
    <link rel="shortcut icon" href="/app/assets/images/favicon.png" />
    <!-- Page Title  -->
    <title>Documents | Document Controller</title>
    <!-- StyleSheets  -->
    <link rel="stylesheet" href="/app/assets/css/dashlite.css" />
    <link id="skin-default" rel="stylesheet" href="/app/assets/css/theme.css" />
    <link rel="stylesheet" href="./styles.css">
</head>

<body class="nk-body bg-lighter npc-general has-sidebar">
    <div class="nk-app-root">
        <!-- main @s -->
        <div class="nk-main">
            <%- include('./common/sidebar' , {active : "Documents" }); -%>
                <div class="nk-wrap">
                    <%- include('./common/navbar'); -%>
                        <div class="nk-content">
                            <div class="container-fluid">
                                <div class="nk-content-inner">
                                    <div class="nk-content-body">
                                        <div class="nk-block">
                                            <div class="nk-block-head nk-block-head-sm">
                                                <div class="nk-block-between g-3">
                                                    <div class="nk-block-head-content">
                                                        <div class="row align-items-center">
                                                            <div class="col">
                                                                <h3 class="nk-block-title page-title">Documents</h3>
                                                            </div>
                                                            <div class="col  px-0 ">
                                                                <div class="nk-tb-col px-0 py-0 replied-vide-select">
                                                                    <span>
                                                                        <select
                                                                            class="form-select form-control js-select2 "
                                                                            data-filter="single" id="select-site"
                                                                            name="doc_folder"
                                                                            data-placeholder="Select Folder">
                                                                            <option value="select-site">Select Site
                                                                            </option>
                                                                            <% sites.forEach(site=> { %>
                                                                                <option id="<%= site.site_id %>"
                                                                                    value="<%= site.site_name %>">
                                                                                    <%= site.site_name %>
                                                                                </option>
                                                                                <% }); %>
                                                                        </select>
                                                                    </span>
                                                                </div>

                                                            </div>
                                                            <div id="fetch-replied-vid"
                                                                class="col replied-vide-btn disable">
                                                                <button type="submit" class="btn btn-primary">Fetch
                                                                    Replied Vide</button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <%if(token.user_role !=3){%>
                                                        <div class="nk-block-head-content">
                                                            <%if(token.user_role==0 || token.user_role==1 ||
                                                                token.user_role==2){%>
                                                                <a href="/ai-import"
                                                                    class="btn btn-white btn-dim btn-outline-light"><span>AI
                                                                        Import</span></a>
                                                                <%if(token.user_role!=2){%>
                                                                    <span class="drodown">
                                                                        <a href="#"
                                                                            class="dropdown-toggle btn btn-white btn-dim btn-outline-light"
                                                                            data-bs-toggle="dropdown"><em
                                                                                class="icon ni ni-inbox-in"></em><span><span
                                                                                    class="d-none d-md-inline">Import</a>
                                                                        <div style="min-width: 140px;"
                                                                            class="dropdown-menu dropdown-menu-end">
                                                                            <ul class="link-list-opt no-bdr">
                                                                                <li>
                                                                                    <a class="btn-sm"
                                                                                        href="/documents/import/bulk"><em
                                                                                            class="icon ni ni-folder-fill"></em><span>Bulk
                                                                                            Import</span></a>
                                                                                </li>
                                                                            </ul>
                                                                        </div>
                                                                    </span>
                                                                    <%}%>
                                                                        <%}%>
                                                                            <a href="/documents/create-document"
                                                                                class="btn btn-white btn-dim btn-outline-light"><em
                                                                                    class="icon ni ni-plus-sm"></em><span>Add
                                                                                    Document</span></a>
                                                        </div>
                                                        <%}%>
                                                </div>
                                            </div>
                                            <div class="card card-bordered card-stretch">
                                                <div class="card-inner-group">
                                                    <div class="card-inner position-relative card-tools-toggle">
                                                        <div class="card-title-group">
                                                            <div class="card-tools"></div>
                                                            <div class="card-tools me-n1">
                                                                <ul class="btn-toolbar gx-1">
                                                                    <li>
                                                                        <a href="#"
                                                                            class="btn btn-icon search-toggle toggle-search"
                                                                            data-target="search"><em
                                                                                class="icon ni ni-search"></em></a>
                                                                    </li>
                                                                    <li class="btn-toolbar-sep"></li>
                                                                    <li>
                                                                        <div class="toggle-wrap">
                                                                            <a href="#"
                                                                                class="btn btn-icon btn-trigger toggle"
                                                                                data-target="cardTools"><em
                                                                                    class="icon ni ni-menu-right"></em></a>
                                                                            <div class="toggle-content"
                                                                                data-content="cardTools">
                                                                                <ul class="btn-toolbar gx-1">
                                                                                    <li class="toggle-close">
                                                                                        <a href="#"
                                                                                            class="btn btn-icon btn-trigger toggle"
                                                                                            data-target="cardTools"><em
                                                                                                class="icon ni ni-arrow-left"></em></a>
                                                                                    </li>
                                                                                    <li>
                                                                                        <div class="dropdown">
                                                                                            <a href="#"
                                                                                                class="btn btn-trigger btn-icon dropdown-toggle"
                                                                                                data-bs-toggle="dropdown">
                                                                                                <em
                                                                                                    class="icon ni ni-setting"></em>
                                                                                            </a>
                                                                                            <div
                                                                                                class="dropdown-menu dropdown-menu-xs dropdown-menu-end">
                                                                                                <ul
                                                                                                    class="filter-limit link-check">
                                                                                                    <li><span>Show</span>
                                                                                                    </li>
                                                                                                    <li class="active">
                                                                                                        <a href="#"
                                                                                                            data-limit="10">10</a>
                                                                                                    </li>
                                                                                                    <li><a href="#"
                                                                                                            data-limit="20">20</a>
                                                                                                    </li>
                                                                                                    <li><a href="#"
                                                                                                            data-limit="50">50</a>
                                                                                                    </li>
                                                                                                    <li><a href="#"
                                                                                                            data-limit="100">100</a>
                                                                                                    </li>
                                                                                                </ul>
                                                                                            </div>

                                                                                        </div>
                                                                                    </li>
                                                                                </ul>
                                                                            </div>

                                                                        </div>
                                                                    </li>
                                                                    <li>
                                                                        <a id="resetFilters"
                                                                            class="btn btn-dim btn-outline-primary">
                                                                            <em class="icon ni ni-reload-alt"></em>
                                                                            <span>Reset Filter</span>
                                                                        </a>
                                                                    </li>
                                                                    <li>
                                                                        <div class="scroll-buttons">
                                                                            <a id="scroll-left"
                                                                                class="btn btn-icon btn-primary"><em
                                                                                    class="icon ni ni-chevron-left"></em></a>
                                                                            <a id="scroll-right"
                                                                                class="btn btn-icon btn-primary"><em
                                                                                    class="icon ni ni-chevron-right"></em></a>
                                                                        </div>
                                                                    </li>
                                                                </ul>
                                                            </div>
                                                        </div>
                                                        <div class="card-search search-wrap" data-search="search">
                                                            <div class="card-body">
                                                                <div class="search-content">
                                                                    <a href="#"
                                                                        class="search-back btn btn-icon toggle-search"
                                                                        data-target="search"><em
                                                                            class="icon ni ni-arrow-left"></em></a>
                                                                    <input type="text" id="doc_ocr_content"
                                                                        class="form-control border-transparent form-focus-none filter-input"
                                                                        data-filter="keyword"
                                                                        placeholder="Search Keywords" />
                                                                    <button id="searchDocumentButton"
                                                                        class="search-submit btn btn-icon"><em
                                                                            class="icon ni ni-search"></em></button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="card-inner p-0 scrollable-datatable">
                                                        <div class="nk-tb-list nk-tb-ulist is-compact">
                                                            <div class="nk-tb-item nk-tb-head" id="table-head">
                                                                <%if(token.user_role !=3){%>
                                                                    <div class="nk-tb-col no-click  text-start">
                                                                        <span data-field="edit_doc">ACTIONS</span><span
                                                                            class="sort-indicator"></span>
                                                                    </div>
                                                                    <%}%>
                                                                        <div class="nk-tb-col ">
                                                                            <span data-field="doc_site">SITE</span><span
                                                                                class="sort-indicator"></span>
                                                                        </div>
                                                                        <div class="nk-tb-col">
                                                                            <span
                                                                                data-field="doc_folder">FOLDER</span><span
                                                                                class="sort-indicator"></span>
                                                                        </div>
                                                                        <div class="nk-tb-col">
                                                                            <span data-field="doc_type">TYPE</span><span
                                                                                class="sort-indicator"></span>
                                                                        </div>
                                                                        <div class="nk-tb-col">
                                                                            <span
                                                                                data-field="doc_number">NUMBER</span><span
                                                                                class="sort-indicator"></span>
                                                                        </div>
                                                                        <div class="nk-tb-col">
                                                                            <span
                                                                                data-field="doc_status">STATUS</span><span
                                                                                class="sort-indicator"></span>
                                                                        </div>
                                                                        <div class="nk-tb-col">
                                                                            <span
                                                                                data-field="doc_created_at">DATE</span><span
                                                                                class="sort-indicator"></span>
                                                                        </div>

                                                                        <div class="nk-tb-col">
                                                                            <span
                                                                                data-field="doc_subject">SUBJECT</span><span
                                                                                class="sort-indicator"></span>
                                                                        </div>



                                                                        <div class="nk-tb-col">
                                                                            <span
                                                                                data-field="doc_reference">REFERENCE</span><span
                                                                                class="sort-indicator"></span>
                                                                        </div>
                                                                        <div class="nk-tb-col">
                                                                            <span data-field="doc_replied_vide">REPLIED
                                                                                VIDE</span><span
                                                                                class="sort-indicator"></span>
                                                                        </div>

                                                                        <div class="nk-tb-col">
                                                                            <span
                                                                                data-field="doc_purpose">ENCLOSURES</span><span
                                                                                class="sort-indicator"></span>
                                                                        </div>
                                                                        <div class="nk-tb-col">
                                                                            <span data-field="doc_from">FROM</span><span
                                                                                class="sort-indicator"></span>
                                                                        </div>
                                                                        <div class="nk-tb-col">
                                                                            <span data-field="doc_to">TO</span><span
                                                                                class="sort-indicator"></span>
                                                                        </div>
                                                                        <div class="nk-tb-col">
                                                                            <span
                                                                                data-field="doc_storage_location">STORAGE</span><span
                                                                                class="sort-indicator"></span>
                                                                        </div>
                                                            </div>

                                                            <div class="nk-tb-item nk-tb-head" id="table-filters">
                                                                <%if(token.user_role !=3){%>
                                                                    <div class="nk-tb-col text-start">
                                                                        <span>
                                                                        </span>
                                                                    </div>
                                                                    <%}%>
                                                                        <div class="nk-tb-col ">
                                                                            <span>
                                                                                <select
                                                                                    class="form-select form-control js-select2 filter-input"
                                                                                    data-filter="multiple" id="doc_site"
                                                                                    name="doc_site"
                                                                                    data-placeholder="Site" multiple>
                                                                                    <option label="empty" value="">
                                                                                    </option>
                                                                                    <% sites.forEach(site=> { %>
                                                                                        <option
                                                                                            value="<%= site.site_name %>">
                                                                                            <%= site.site_name %>
                                                                                        </option>
                                                                                        <% }); %>
                                                                                </select>
                                                                            </span>
                                                                        </div>
                                                                        <div class="nk-tb-col">
                                                                            <span>
                                                                                <select
                                                                                    class="form-select form-control js-select2 filter-input"
                                                                                    data-filter="multiple"
                                                                                    id="doc_folder" name="doc_folder"
                                                                                    data-placeholder="Folder" multiple>
                                                                                    <option value="">Select Folder
                                                                                    </option>
                                                                                    <% folders.forEach(folder=> { %>
                                                                                        <option
                                                                                            value="<%= folder.site_name %>">
                                                                                            <%= folder.site_name %>
                                                                                        </option>
                                                                                        <% }); %>
                                                                                </select>
                                                                            </span>
                                                                        </div>
                                                                        <div class="nk-tb-col">
                                                                            <span>
                                                                                <select
                                                                                    class="form-select form-control js-select2 filter-input"
                                                                                    data-filter="text" id="doc_type"
                                                                                    name="doc_type"
                                                                                    data-placeholder="Select Type">
                                                                                    <option label="empty" value="">
                                                                                    </option>
                                                                                    <option label="INCOMING"
                                                                                        value="INCOMING">INCOMING
                                                                                    </option>
                                                                                    <option label="OUTGOING"
                                                                                        value="OUTGOING">OUTGOING
                                                                                    </option>
                                                                                </select>
                                                                            </span>
                                                                        </div>
                                                                        <div class="nk-tb-col">
                                                                            <span>
                                                                                <input type="text"
                                                                                    class="form-control filter-input"
                                                                                    data-filter="text" id="doc_number"
                                                                                    placeholder="Number">
                                                                            </span>
                                                                        </div>
                                                                        <div class="nk-tb-col">
                                                                            <span>
                                                                                <select
                                                                                    class="form-select form-control js-select2 filter-input"
                                                                                    data-filter="text" id="doc_status"
                                                                                    name="doc_status"
                                                                                    data-placeholder="Select Status">
                                                                                    <option label="empty" value="">
                                                                                    </option>
                                                                                    <option label="INSERTED"
                                                                                        value="INSERTED">INSERTED
                                                                                    </option>
                                                                                    <option label="DRAFTED"
                                                                                        value="DRAFTED">DRAFTED</option>
                                                                                    <option label="UPLOADED"
                                                                                        value="UPLOADED">UPLOADED
                                                                                    </option>
                                                                                </select>
                                                                            </span>
                                                                        </div>
                                                                        <div class="nk-tb-col">
                                                                            <span>
                                                                                <div class="form-group">
                                                                                    <div class="form-control-wrap">
                                                                                        <input placeholder="Date"
                                                                                            id="doc_date" type="text"
                                                                                            class="form-control date-picker filter-input"
                                                                                            data-filter="date">
                                                                                    </div>
                                                                                </div>
                                                                            </span>
                                                                        </div>

                                                                        <div class="nk-tb-col">
                                                                            <span>
                                                                                <input type="text"
                                                                                    class="form-control filter-input"
                                                                                    data-filter="text" id="doc_subject"
                                                                                    placeholder="Subject">
                                                                            </span>
                                                                        </div>


                                                                        <div class="nk-tb-col">
                                                                            <span>
                                                                                <select
                                                                                    class="form-select form-control js-select2 filter-input"
                                                                                    data-filter="multiple"
                                                                                    id="doc_reference"
                                                                                    name="doc_reference"
                                                                                    data-placeholder="Select Reference"
                                                                                    multiple>
                                                                                    <option label="empty" value="">
                                                                                    </option>

                                                                                </select>
                                                                            </span>
                                                                        </div>
                                                                        <div class="nk-tb-col">
                                                                            <span>
                                                                                <select
                                                                                    class="form-select form-control js-select2 filter-input"
                                                                                    data-filter="text"
                                                                                    id="doc_replied_vide"
                                                                                    name="doc_replied_vide"
                                                                                    data-placeholder="Select Replied Vide"
                                                                                    multiple>
                                                                                    <option label="empty" value="">
                                                                                    </option>
                                                                                </select>
                                                                            </span>
                                                                        </div>



                                                                        <div class="nk-tb-col">
                                                                            <span>
                                                                                <select
                                                                                    class="form-select form-control js-select2 filter-input"
                                                                                    data-filter="text" id="doc_purpose"
                                                                                    name="doc_purpose"
                                                                                    data-placeholder="Select Purpose">
                                                                                    <option label="empty" value="">
                                                                                    </option>
                                                                                    <option label="DESIGN & DRAWINGS"
                                                                                        value="DESIGN & DRAWINGS">DESIGN
                                                                                        & DRAWINGS
                                                                                    </option>
                                                                                    <option label="EOT" value="EOT">EOT
                                                                                    </option>
                                                                                    <option label="OTHERS"
                                                                                        value="OTHERS">OTHERS</option>
                                                                                </select>
                                                                            </span>
                                                                        </div>
                                                                        <div class="nk-tb-col">
                                                                            <span>
                                                                                <input type="text"
                                                                                    class="form-control filter-input"
                                                                                    data-filter="text" id="doc_from"
                                                                                    placeholder="Subject">
                                                                            </span>
                                                                        </div>
                                                                        <div class="nk-tb-col">
                                                                            <span>
                                                                                <input type="text"
                                                                                    class="form-control filter-input"
                                                                                    data-filter="text" id="doc_to"
                                                                                    placeholder="Subject">
                                                                            </span>
                                                                        </div>
                                                                        <div class="nk-tb-col">
                                                                            <span>
                                                                                <input type="text"
                                                                                    class="form-control filter-input"
                                                                                    data-filter="text"
                                                                                    id="doc_storage_location"
                                                                                    placeholder="Storage">
                                                                            </span>
                                                                        </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div id="table-status" class="card-inner text-center">
                                                        <div class="text-center">
                                                            <p>No Data Found</p>
                                                        </div>
                                                    </div>

                                                    <div id="table-pagination" class="card-inner">
                                                        <ul class="pagination">
                                                            <li class="paginate_button page-item previous disabled"
                                                                id="DataTables_Table_2_previous">
                                                                <a aria-controls="DataTables_Table_2"
                                                                    aria-disabled="true" role="link"
                                                                    data-dt-idx="previous" tabindex="0"
                                                                    class="page-link">Prev</a>
                                                            </li>
                                                            <!-- Pagination numbers will be dynamically inserted here -->
                                                            <li class="paginate_button page-item next"
                                                                id="DataTables_Table_2_next">
                                                                <a aria-controls="DataTables_Table_2" role="link"
                                                                    data-dt-idx="next" tabindex="0"
                                                                    class="page-link">Next</a>
                                                            </li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <%- include('./common/footer'); -%>
                </div>
        </div>
        <button style="display: none" id="open-modal" type="button" class="btn btn-primary" data-bs-toggle="modal"
            data-bs-target="#staticBackdrop">
            Launch static backdrop modal
        </button>

        <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
            aria-labelledby="staticBackdropLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="staticBackdropLabel">Delete Document</h5>
                        <button type="button" id="closeModal" class="btn-close" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>Are you sure you want to delete this document ? </p>
                    </div>
                    <div class="modal-footer" id="modalAction">
                        <button type="button" class="btn btn-secondary" id="rejectModelBtn"
                            data-bs-dismiss="modal">No</button>
                        <button type="button" id="deleteDocument" class="btn btn-primary">Yes</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/app/assets/js/bundle.js"></script>
    <script src="/app/assets/js/scripts.js"></script>
    <script src="/app/views/manage-bg/manage-bg-script.js"></script>
    <script>
        let filters = {
            limit: 10,
            page: 1,
            sort: {},
            activeFilter: {},
        };

        $('.js-select2').select2({
            placeholder: 'Select an option',
            width: 'resolve'
        });

        $('#table-pagination').on('click', 'a', handlePaginationClick);

        $('#scroll-left').on('click', function () {
            $('.scrollable-datatable').animate({ scrollLeft: '-=300' }, 200);
        });

        $('#scroll-right').on('click', function () {
            $('.scrollable-datatable').animate({ scrollLeft: '+=300' }, 200);
        });

        function resetSortFilter() {
            $("#table-head .nk-tb-col").removeClass("sort-asc sort-dsc active");
        }

        $('#resetFilters').on('click', function () {
            if (Object.keys(filters.activeFilter).length) {
                filters = {
                    limit: 10,
                    page: 1,
                    sort: {},
                    activeFilter: {},
                };
                resetSortFilter()
                // all filters to val "empty"
                const resetFields = [
                    '#doc_folder',
                    '#doc_site',
                    '#doc_type',
                    '#doc_status',
                    '#doc_created_at',
                    '#doc_purpose',
                ];
                resetFields.forEach((selector) => {
                    const $field = $(selector);
                    if ($field.val() !== "empty") {
                        $field.val("empty").trigger('change');
                    }
                });
                // all filters with input reset val ""
                const resetFieldsEmpty = [
                    '#doc_subject',
                    '#doc_from',
                    '#doc_to',
                    '#doc_storage_location',
                    '#doc_date',
                    '#doc_number',
                ];

                resetFieldsEmpty.forEach((selector) => {
                    const $field = $(selector);
                    if ($field.val() !== "") {
                        $field.val("").trigger('change');
                    }
                });

                return
            }

            if (Object.keys(filters.sort).length) {
                resetSortFilter()
                filters = {
                    limit: 10,
                    page: 1,
                    sort: {},
                    activeFilter: {},
                };
                fetchDocuments()
            }


        });


        $(document).on('click', '#deleteDoc', function (event) {
            event.preventDefault();
            let openModal = document.getElementById('open-modal')
            docIdToDelete = $(this).data('id');
            if (docIdToDelete) {
                openModal.click();
            }
        });

        $(document).on('click', '#deleteDocument', function (event) {
            const modalCloseBtn = document.querySelector('#closeModal');
            event.preventDefault();
            $(`#modalAction`).addClass('disable');
            $.ajax({
                type: "POST",
                url: "/docs/delete-doc/",
                data: { docId: docIdToDelete },
                success: function (response) {
                    if (response.status == 0) {
                        NioApp.Toast("<h5>Deleted Successfully</h5><p>Document deleted successfully!</p>", "success");
                        modalCloseBtn.click();
                        fetchDocuments();
                        $(`#modalAction`).removeClass('disable');

                    } else {
                        NioApp.Toast(`<h5>Something Went Wrong</h5>${response.msg || `<p>Error while Document deleted</p>`}`, "error");
                        modalCloseBtn.click();
                        $(`#modalAction`).removeClass('disable');

                    }
                },

                error: function (xhr, status, error) {
                    NioApp.Toast(`<h5>Something Went Wrong</h5>${response.msg || `<p>Error while Document deleted</p>`}`, "error");
                    modalCloseBtn.click();
                    $(`#modalAction`).removeClass('disable');
                },
            });
        });



    </script>
</body>

</html>