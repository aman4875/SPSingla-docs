<!DOCTYPE html>
<html lang="zxx" class="js">

<head>
    <base href="../" />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" />
    <!-- Fav Icon  -->
    <link rel="shortcut icon" href="/app/assets/images/favicon.png" />
    <!-- Page Title  -->
    <title>Dashboard | ProjectMaster</title>
    <!-- StyleSheets  -->
    <link rel="stylesheet" href="/app/assets/css/dashlite.css" />
    <link id="skin-default" rel="stylesheet" href="/app/assets/css/theme.css" />
    <link rel="stylesheet" href="/app/views/project-master/style.css" />
    <style>
        .fdr-section label.form-label {
            text-transform: capitalize;
        }
    </style>
</head>

<body class="nk-body bg-lighter npc-general has-sidebar">
    <div class="nk-app-root">
        <div class="nk-main">
            <%- include('./common/sidebar' , {active : "fdr" }); -%>
                <div class="nk-wrap">

                    <div class="nk-content fdr-section">
                        <div class="container-fluid">
                            <div class="nk-content-inner">
                                <div class="nk-content-body">
                                    <div class="nk-block nk-block-lg">
                                        <div class="nk-block-head nk-block-head-sm">
                                            <div class="nk-block-between g-3">
                                                <div class="nk-block-head-content d-flex">
                                                    <h3 class="nk-block-title page-title">Add FDR</h3>
                                                    <button id="saveDraftButton"
                                                        style="margin: -5px 20px 5px 20px; min-width: 88px"
                                                        class="btn btn-sm btn-dim btn-outline-primary d-none text-center">Save
                                                        Draft</button>
                                                </div>

                                                <div class="nk-block-head-content">
                                                    <a href="/fdr"
                                                        class="btn btn-outline-light bg-white d-none d-sm-inline-flex"><em
                                                            class="icon ni ni-arrow-left"></em><span>Back</span></a>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="card card-bordered">
                                            <div class="card-inner">
                                                <form id="documentForm" class="form-validate is-alter">
                                                    <div class="row g-gs">
                                                        <div class="col-md-4">
                                                            <div class="form-group">
                                                                <label class="form-label" for="doc_bank_name">Bank
                                                                    Name</label>
                                                                <div class="form-control-wrap">
                                                                    <select class="form-select form-control js-select2"
                                                                        data-filter="single" id="select-site"
                                                                        name="doc_bank_name"
                                                                        data-placeholder="Select Folder" required>
                                                                        <option value="" disabled selected>Select Bank
                                                                            Name</option>
                                                                        <% banks.forEach(bank=> { %>
                                                                            <option data-code="<%= bank.bank_code %>"
                                                                                id="<%= bank.doc_id %>"
                                                                                value="<%= bank.bank_name %>">
                                                                                <%= bank.bank_name %>
                                                                            </option>
                                                                            <% }); %>
                                                                    </select>

                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <div class="form-group">
                                                                <label class="form-label"
                                                                    for="doc_purpose">Purpose</label>
                                                                <div class="form-control-wrap">
                                                                    <input type="text" class="form-control"
                                                                        placeholder="Purpose" id="doc_purpose"
                                                                        name="doc_purpose" value="" required />
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <div class="form-group">
                                                                <label class="form-label" for="doc_fdr_no">FDR
                                                                    NO</label>
                                                                <div class="form-control-wrap">
                                                                    <input type="text" class="form-control"
                                                                        placeholder="FDR NO" id="doc_fdr_no"
                                                                        name="doc_fdr_no" value="" required />
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <div class="form-group">
                                                                <label class="form-label"
                                                                    for="doc_original_issue_date">Original issue
                                                                    date</label>
                                                                <div class="form-control-wrap focused">
                                                                    <div class="form-icon form-icon-right"><em
                                                                            class="icon ni ni-calendar-alt"></em></div>
                                                                    <input type="text" required
                                                                        id="doc_original_issue_date" autocomplete="off"
                                                                        name="doc_original_issue_date"
                                                                        placeholder="Original Issue Date"
                                                                        class="form-control date-picker" value="" />
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <div class="col-md-4">
                                                            <div class="form-group">
                                                                <label class="form-label"
                                                                    for="doc_interest_payout_clause">Interest Payout
                                                                    clause</label>
                                                                <div class="form-control-wrap">
                                                                    <select class="form-select form-control js-select2"
                                                                        id="doc_interest_payout_clause"
                                                                        name="doc_interest_payout_clause"
                                                                        data-placeholder="Select or Type" required>
                                                                        <option label="empty" value=""></option>
                                                                        <% payoutClauseData.forEach(data=> { %>
                                                                            <option data-id="<%= data.id %>"
                                                                                value="<%= data.clause_name %>">
                                                                                <%= data.clause_name %>
                                                                            </option>
                                                                            <% }); %>
                                                                    </select>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <div class="col-md-4">
                                                            <div class="form-group">
                                                                <label class="form-label"
                                                                    for="doc_deposit_amount">Deposit amount</label>
                                                                <div class="form-control-wrap">
                                                                    <div class="input-group">
                                                                        <input type="number" class="form-control"
                                                                            placeholder="Deposit Amount"
                                                                            id="doc_deposit_amount"
                                                                            name="doc_deposit_amount" value=""
                                                                            required />

                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <div class="col-md-4">
                                                            <div class="form-group">
                                                                <label class="form-label"
                                                                    for="doc_deposit_amount">Interest rate</label>
                                                                <div class="form-control-wrap">
                                                                    <div class="input-group">
                                                                        <input type="number" class="form-control"
                                                                            placeholder="Interest Rate"
                                                                            id="doc_interest_rate"
                                                                            name="doc_interest_rate" value=""
                                                                            required />

                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <div class="col-md-4">
                                                            <div class="form-group">
                                                                <label class="form-label" for="doc_tds_rate">TDS
                                                                    rate</label>
                                                                <div class="form-control-wrap">
                                                                    <input type="number" class="form-control"
                                                                        placeholder="DS Rate" id="doc_tds_rate"
                                                                        name="doc_tds_rate" value="" required />
                                                                </div>
                                                                <small id="error-msg" class="text-danger"
                                                                    style="display:none;"></small>
                                                            </div>
                                                        </div>

                                                        <div class="col-md-4">
                                                            <div class="form-group">
                                                                <label class="form-label" for="doc_tenor">Tenor (in
                                                                    months)</label>
                                                                <div class="form-control-wrap focused">
                                                                    <div class="form-icon form-icon-right"></div>
                                                                    <input required type="text" id="doc_tenor"
                                                                        autocomplete="off" name="doc_tenor"
                                                                        placeholder="Tenor (in months)"
                                                                        class="form-control" value="" />
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <div class="col-sm-4">
                                                            <div class="form-group">
                                                                <label class="form-label" for="doc_new_tenor">New
                                                                    Tenor (in months)</label>
                                                                <div class="form-control-wrap focused">
                                                                    <div class="form-icon form-icon-right"></div>
                                                                    <input required type="text" id="doc_new_tenor"
                                                                        autocomplete="off" name="doc_new_tenor"
                                                                        placeholder="New Tenor (in months)"
                                                                        class="form-control" value="" />
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <div class="col-md-4">
                                                            <div class="form-group">
                                                                <label class="form-label"
                                                                    for="doc_renewal">Renewal</label>
                                                                <div class="form-control-wrap">
                                                                    <input required type="text" class="form-control"
                                                                        placeholder="Renewal" id="doc_renewal"
                                                                        name="doc_renewal" value="" />
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <div class="col-md-4">
                                                            <div class="form-group">
                                                                <label class="form-label" for="doc_renewal_date">Issue
                                                                    Date / Renewal Date</label>
                                                                <div class="form-control-wrap">
                                                                    <input required type="text"
                                                                        class="form-control date-picker"
                                                                        placeholder="Issue Date / Renewal Dates"
                                                                        id="doc_renewal_date" name="doc_renewal_date"
                                                                        value="" />
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <div class="form-group">
                                                                <label class="form-label"
                                                                    for="doc_renewal_amount">Renewal
                                                                    Amount</label>
                                                                <div class="form-control-wrap">
                                                                    <input required type="text" class="form-control"
                                                                        placeholder="Renewal Amount"
                                                                        id="doc_renewal_amount"
                                                                        name="doc_renewal_amount" value="" />
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <div class="form-group">
                                                                <label class="form-label"
                                                                    for="doc_maturity_date">Maturity
                                                                    Date</label>
                                                                <div class="form-control-wrap">
                                                                    <input required type="text"
                                                                        class="form-control date-picker"
                                                                        placeholder="Maturity Date"
                                                                        id="doc_maturity_date" name="doc_maturity_date"
                                                                        value="" />
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <div class="col-md-4">
                                                            <div class="form-group">
                                                                <label class="form-label"
                                                                    for="doc_maturity_amount">Maturity
                                                                    Amount</label>
                                                                <div class="form-control-wrap">
                                                                    <input step="any" required type="number"
                                                                        class="form-control"
                                                                        placeholder="Maturity Amount"
                                                                        id="doc_maturity_amount"
                                                                        name="doc_maturity_amount" value="" />
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <div class="col-md-4">
                                                            <div class="form-group">
                                                                <label class="form-label" for="doc_interest">Acc.
                                                                    Interest</label>
                                                                <div class="form-control-wrap">
                                                                    <input step="any" required type="number"
                                                                        class="form-control" placeholder="Acc. Interest"
                                                                        id="doc_interest" name="doc_interest"
                                                                        value="" />
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <div class="col-md-4">
                                                            <div class="form-group">
                                                                <label class="form-label" for="doc_tds">TDS</label>
                                                                <div class="form-control-wrap">
                                                                    <input step="any" required type="number"
                                                                        class="form-control" placeholder="TDS"
                                                                        id="doc_tds" name="doc_tds" value="" />
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <div class="col-md-4">
                                                            <div class="form-group">
                                                                <label class="form-label"
                                                                    for="doc_margin_available">Margin Available</label>
                                                                <div class="form-control-wrap">
                                                                    <input step="any" required type="number"
                                                                        class="form-control" placeholder="Closed On"
                                                                        id="doc_margin_available"
                                                                        name="doc_margin_available" value="" />
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <div class="col-md-4">
                                                            <div class="form-group">
                                                                <label class="form-label" for="doc_closed_on">Closed
                                                                    on</label>
                                                                <div class="form-control-wrap">
                                                                    <input type="text" class="form-control date-picker"
                                                                        placeholder="Closed On" id="doc_closed_on"
                                                                        name="doc_closed_on" value="" />
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <div class="col-md-12">
                                                            <div class="form-group">
                                                                <button id="uploadDocumentBtn" type="submit"
                                                                    class="btn btn-lg btn-primary">Save</button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <%- include('./common/footer'); -%>
                </div>
        </div>
    </div>
    <script src="/app/assets/js/bundle.js"></script>
    <script src="/app/assets/js/scripts.js"></script>
    <script src="/app/assets/js/charts/gd-default.js"></script>
    <script src="/app/views/Fdr/add-fdr-script.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/decimal.js@10.4.3/decimal.min.js"></script>
    <script>
        let projectData = {
            projectCode: null,
            projectName: null
        }
        let closedByBackdropClick = false;
        let dplEndingMonths = 0


        $(document).ready(function () {
            $("#documentForm").submit(function (event) {
                event.preventDefault();
                if (!this.checkValidity()) {
                    return false;
                }
                console.log("Form submitted successfully!");

                const selectedOption = $('#select-site option:selected');
                const bankCode = selectedOption.data('code');
                const bankDocId = selectedOption.attr('id');
                NioApp.handleButtonState("uploadDocumentBtn", "Upload", true);

                let formData = new FormData(this);
                formData.append("bank_code", bankCode);
                formData.append("bank_id", bankDocId);
                // Your AJAX request
                $.ajax({
                    type: "POST",
                    url: "/fdr/create-fdr",
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (response) {
                        if (response.status == 1) {
                            NioApp.handleButtonState("uploadDocumentBtn", "Upload", false);
                            NioApp.Toast("<h5>Document Uploaded</h5><p>Document Uploaded Successfully</p>", "success");
                            window.location.href = '/fdr'
                        } else if (response.status == 0) {
                            NioApp.handleButtonState("uploadDocumentBtn", "Upload", false);
                            NioApp.Toast(`<h5>Error Occurred</h5><p>${response.msg}</p>`, "error");
                        } else NioApp.Toast("<h5>Something Went Wrong</h5><p>Error while uploading Document</p>", "error");
                    },
                    error: function (xhr, status, error) {
                        NioApp.handleButtonState("uploadDocumentBtn", "Upload", false);
                        NioApp.Toast("<h5>Something Went Wrong</h5><p>Error while uploading Document</p>", "error");
                        console.error("Error saving draft:", error);
                    },
                });
            });
        });

        function parseDDMMYYYY(dateStr) {
            const [dd, mm, yyyy] = dateStr.split('/');
            return new Date(Number(yyyy), Number(mm) - 1, Number(dd));
        }

        $(document).ready(function (params) {
            const bindEvents = "change keyup";
            function calculateAccountInterest(principal, annualRatePercent, startDateStr) {
                const now = new Date(); // Includes time of day like Excel's NOW()
                const startDate = parseDDMMYYYY(startDateStr);

                const msInDay = 1000 * 60 * 60 * 24;
                const diffMs = now.getTime() - startDate.getTime();
                const diffDays = new Decimal(diffMs).div(msInDay); // Allow fractional days!s
                if (diffDays.lte(0)) return "0.00";

                const principalDecimal = new Decimal(principal);
                const rateDecimal = new Decimal(annualRatePercent).div(100);

                const interest = principalDecimal
                    .mul(rateDecimal)
                    .div(365)
                    .mul(diffDays);
                return interest.toFixed(2);
            }


            function calculateTDS(accruedInterest, tdsRate = 10.0) {
                if (isNaN(accruedInterest) || accruedInterest <= 0) return "0.00";
                const tdsAmount = (tdsRate / 100) * accruedInterest;
                return tdsAmount.toFixed(2);
            }


            function calculateMarginAvailable(renewalAmount, accruedInterest, tdsAmount) {
                if (isNaN(renewalAmount) || renewalAmount <= 0 || !tdsAmount) return "0.00";
                const netInterest = accruedInterest - tdsAmount;
                const marginAvailable = renewalAmount + netInterest;
                return marginAvailable.toFixed(2);
            }

            $("#doc_renewal_date, #doc_renewal_amount, #doc_interest_rate, #doc_tds_rate").on(bindEvents, function () {
                const principal = parseFloat($("#doc_renewal_amount").val());
                const annualRatePercent = parseFloat($("#doc_interest_rate").val());
                const startDateStr = $("#doc_renewal_date").val();
                const tdsRate = parseFloat($("#doc_tds_rate").val());

                if (isNaN(principal) || isNaN(annualRatePercent) || startDateStr === "") {
                    $("#doc_interest").val("0.00");
                    return;
                }

                const interest = calculateAccountInterest(principal, annualRatePercent, startDateStr);
                const tds = calculateTDS(interest, tdsRate);
                const marginAvailable = calculateMarginAvailable(principal, interest, tds)
                $("#doc_interest").val(interest).trigger("change");
                $("#doc_tds").val(tds).trigger("change");
                $("#doc_margin_available").val(marginAvailable).trigger("change");
            });
        });

    </script>
</body>

</html>